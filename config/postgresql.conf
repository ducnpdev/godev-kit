# PostgreSQL Configuration for Mac (8 CPU, 16GB RAM)
# Optimized for development and moderate production workloads

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# Connection Settings
max_connections = 200                    # Increased for your hardware
superuser_reserved_connections = 3
unix_socket_directories = '/tmp'         # For macOS
listen_addresses = 'localhost'
port = 5433
max_worker_processes = 8                 # Match your CPU cores
max_parallel_workers_per_gather = 4      # 50% of CPU cores
max_parallel_workers = 8                 # Match your CPU cores
max_parallel_maintenance_workers = 2     # For maintenance operations

#------------------------------------------------------------------------------
# MEMORY SETTINGS
#------------------------------------------------------------------------------

# Memory Configuration (optimized for 16GB RAM)
shared_buffers = 4GB                     # 25% of RAM (4GB)
effective_cache_size = 12GB              # 75% of RAM (12GB)
maintenance_work_mem = 1GB               # For maintenance operations
work_mem = 16MB                          # Per operation memory
wal_buffers = 16MB                       # WAL buffer size
huge_pages = off                         # Disable for macOS

#------------------------------------------------------------------------------
# WRITE AHEAD LOG
#------------------------------------------------------------------------------

# WAL Configuration
wal_level = replica                      # For replication and point-in-time recovery
fsync = on                               # Ensure data durability
synchronous_commit = on                  # Ensure ACID compliance
wal_sync_method = fsync                 # Default sync method
full_page_writes = on                    # Required for crash recovery
wal_compression = on                     # Compress WAL files
wal_buffers = 16MB                       # WAL buffer size
checkpoint_completion_target = 0.9       # Spread checkpoint writes
checkpoint_timeout = 5min                # Checkpoint interval
max_wal_size = 4GB                       # Maximum WAL size
min_wal_size = 1GB                       # Minimum WAL size

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Query Planner Configuration
random_page_cost = 1.1                   # SSD optimization
effective_io_concurrency = 200           # SSD optimization
default_statistics_target = 100          # Better query planning
constraint_exclusion = partition          # Enable constraint exclusion

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------

# Logging Configuration
log_destination = 'stderr'               # Log to stderr
logging_collector = off                  # Disable for development
log_directory = 'log'                    # Log directory
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d                    # Daily log rotation
log_rotation_size = 100MB                # Log file size limit
log_min_duration_statement = 1000        # Log slow queries (>1s)
log_checkpoints = on                     # Log checkpoints
log_connections = on                     # Log connections
log_disconnections = on                  # Log disconnections
log_lock_waits = on                      # Log lock waits
log_temp_files = 0                       # Log all temp files
log_autovacuum_min_duration = 0          # Log all autovacuum operations

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------

# Autovacuum Configuration
autovacuum = on                          # Enable autovacuum
log_autovacuum_min_duration = 0          # Log all autovacuum operations
autovacuum_max_workers = 3               # Autovacuum workers
autovacuum_naptime = 1min                # Autovacuum frequency
autovacuum_vacuum_threshold = 50         # Vacuum threshold
autovacuum_analyze_threshold = 50        # Analyze threshold
autovacuum_vacuum_scale_factor = 0.2     # Vacuum scale factor
autovacuum_analyze_scale_factor = 0.1    # Analyze scale factor
autovacuum_freeze_max_age = 200000000    # Freeze max age
autovacuum_multixact_freeze_max_age = 400000000

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Statement Behavior
statement_timeout = 30s                  # Query timeout
idle_in_transaction_session_timeout = 10min  # Idle transaction timeout
lock_timeout = 5s                        # Lock acquisition timeout
deadlock_timeout = 1s                    # Deadlock detection timeout

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------

# Lock Configuration
max_locks_per_transaction = 64           # Lock limit per transaction
max_pred_locks_per_transaction = 64      # Predicate lock limit
max_pred_locks_per_relation = -2         # No limit per relation
max_pred_locks_per_page = 2              # Predicate locks per page

#------------------------------------------------------------------------------
# VERSION/PLATFORM COMPATIBILITY
#------------------------------------------------------------------------------

# Compatibility
array_nulls = on                         # Array nulls
backslash_quote = safe_encoding          # Backslash quote
default_with_oids = off                  # No OIDs by default
escape_string_warning = on               # Escape string warnings
lo_compat_privileges = off               # Large object privileges
operator_precedence_warning = off        # Operator precedence warnings
quote_all_identifiers = off              # Quote identifiers
sql_inheritance = on                     # SQL inheritance
standard_conforming_strings = on         # Standard conforming strings
synchronize_seqscans = on                # Synchronize sequential scans

#------------------------------------------------------------------------------
# ERROR REPORTING AND LOGGING
#------------------------------------------------------------------------------

# Error Reporting
log_min_error_statement = error          # Log error statements
log_min_messages = warning               # Minimum log level
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '  # Log prefix
log_statement = 'none'                   # Don't log all statements
log_temp_files = 0                       # Log all temp files

#------------------------------------------------------------------------------
# RUNTIME STATISTICS
#------------------------------------------------------------------------------

# Statistics Configuration
track_activities = on                    # Track activities
track_counts = on                        # Track counts
track_io_timing = on                     # Track I/O timing
track_functions = all                    # Track all functions
stats_temp_directory = 'pg_stat_tmp'     # Statistics temp directory

#------------------------------------------------------------------------------
# AUTOMATIC VACUUM PARAMETERS
#------------------------------------------------------------------------------

# Autovacuum Parameters
autovacuum_vacuum_cost_delay = 20ms      # Vacuum cost delay
autovacuum_vacuum_cost_limit = 200       # Vacuum cost limit
autovacuum_analyze_cost_delay = 20ms     # Analyze cost delay
autovacuum_analyze_cost_limit = 200      # Analyze cost limit 